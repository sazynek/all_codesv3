import pandas as pd
import re

# OKVED классификатор
OKVED_CATEGORIES = {
    "строительство": [
        "41",  # Строительство зданий
        "42",  # Строительство инженерных сооружений
        "43",  # Работы строительные специализированные
        "41.1",
        "41.2",
        "41.3",
        "41.4",
        "41.5",
        "42.1",
        "42.2",
        "42.3",
        "42.4",
        "42.5",
        "42.6",
        "42.7",
        "42.8",
        "42.9",
        "43.1",
        "43.2",
        "43.3",
        "43.4",
        "43.5",
        "43.6",
        "43.7",
        "43.8",
        "43.9",
    ],
    "it и связь": [
        "58",  # Деятельность в области информации и связи
        "59",  # Деятельность в области кинематографии, звукозаписи и издания музыкальных произведений
        "60",  # Деятельность в области телевизионного и радиовещания
        "61",  # Деятельность в сфере телекоммуникаций
        "62",  # Разработка компьютерного программного обеспечения
        "63",  # Деятельность в области информационных технологий
        "58.1",
        "58.2",
        "58.3",
        "58.4",
        "58.5",
        "58.6",
        "58.7",
        "58.8",
        "58.9",
        "59.1",
        "59.2",
        "59.3",
        "59.4",
        "59.5",
        "59.6",
        "60.1",
        "60.2",
        "60.3",
        "60.4",
        "61.1",
        "61.2",
        "61.3",
        "61.4",
        "61.5",
        "61.6",
        "61.7",
        "61.8",
        "61.9",
        "62.0",
        "62.01",
        "62.02",
        "62.03",
        "62.04",
        "62.05",
        "62.06",
        "62.07",
        "62.08",
        "62.09",
        "63.1",
        "63.11",
        "63.12",
        "63.2",
        "63.3",
        "63.4",
        "63.5",
    ],
    "здравоохранение": [
        "86",  # Деятельность в области здравоохранения
        "87",  # Деятельность по уходу с обеспечением проживания
        "88",  # Предоставление социальных услуг без обеспечения проживания
        "86.1",
        "86.2",
        "86.3",
        "86.4",
        "86.5",
        "86.6",
        "86.7",
        "86.8",
        "86.9",
        "87.1",
        "87.2",
        "87.3",
        "87.4",
        "87.5",
        "87.6",
        "87.7",
        "87.8",
        "87.9",
        "88.1",
        "88.2",
        "88.3",
        "88.4",
        "88.5",
        "88.6",
        "88.7",
        "88.8",
        "88.9",
    ],
    "торговля": [
        "45",  # Торговля оптовая и розничная автотранспортными средствами и мотоциклами и их ремонт
        "46",  # Торговля оптовая, кроме оптовой торговли автотранспортными средствами и мотоциклами
        "47",  # Торговля розничная, кроме торговли автотранспортными средствами и мотоциклами
        "45.1",
        "45.2",
        "45.3",
        "45.4",
        "46.1",
        "46.2",
        "46.3",
        "46.4",
        "46.5",
        "46.6",
        "46.7",
        "46.8",
        "46.9",
        "47.1",
        "47.2",
        "47.3",
        "47.4",
        "47.5",
        "47.6",
        "47.7",
        "47.8",
        "47.9",
    ],
    "услуги": [
        "49",
        "50",
        "51",
        "52",
        "53",
        "55",
        "56",
        "68",
        "69",
        "70",
        "71",
        "72",
        "73",
        "74",
        "75",
        "77",
        "78",
        "79",
        "80",
        "81",
        "82",
        "85",
        "90",
        "91",
        "92",
        "93",
        "94",
        "95",
        "96",
        # Транспорт
        "49.1",
        "49.2",
        "49.3",
        "49.4",
        "49.5",
        "50.1",
        "50.2",
        "50.3",
        "50.4",
        "51.1",
        "51.2",
        "52.1",
        "52.2",
        "52.3",
        "53.1",
        "53.2",
        # Гостиницы и общественное питание
        "55.1",
        "55.2",
        "55.3",
        "55.4",
        "55.5",
        "55.6",
        "55.7",
        "55.8",
        "55.9",
        "56.1",
        "56.2",
        "56.3",
        "56.4",
        "56.5",
        "56.6",
        "56.7",
        "56.8",
        "56.9",
        # Недвижимость
        "68.1",
        "68.2",
        "68.3",
        "68.4",
        # Профессиональные услуги
        "69.1",
        "69.2",
        "70.1",
        "70.2",
        "70.3",
        "71.1",
        "71.2",
        "71.3",
        "71.4",
        "72.1",
        "72.2",
        "72.3",
        "73.1",
        "73.2",
        "74.1",
        "74.2",
        "74.3",
        "74.4",
        "74.5",
        "74.6",
        "74.7",
        "74.8",
        "74.9",
        "75.0",
        # Аренда и лизинг
        "77.1",
        "77.2",
        "77.3",
        "77.4",
        # Трудоустройство
        "78.1",
        "78.2",
        "78.3",
        # Туризм
        "79.1",
        "79.2",
        "79.3",
        "79.4",
        "79.5",
        "79.6",
        "79.7",
        "79.8",
        "79.9",
        # Обеспечение безопасности
        "80.1",
        "80.2",
        "80.3",
        # Обслуживание зданий
        "81.1",
        "81.2",
        "81.3",
        "81.4",
        "81.5",
        "81.6",
        "81.7",
        "81.8",
        "81.9",
        # Административные услуги
        "82.1",
        "82.2",
        "82.3",
        "82.4",
        "82.5",
        "82.6",
        "82.7",
        "82.8",
        "82.9",
        # Образование
        "85.1",
        "85.2",
        "85.3",
        "85.4",
        "85.5",
        "85.6",
        # Культура, спорт, развлечения
        "90.0",
        "90.01",
        "90.02",
        "90.03",
        "90.04",
        "91.0",
        "92.0",
        "93.1",
        "93.2",
        "93.3",
        "93.4",
        # Общественные организации
        "94.1",
        "94.2",
        "94.3",
        "94.4",
        "94.5",
        "94.6",
        "94.7",
        "94.8",
        "94.9",
        # Ремонт
        "95.1",
        "95.2",
        "95.3",
        "95.4",
        # Персональные услуги
        "96.0",
        "96.01",
        "96.02",
        "96.03",
        "96.04",
        "96.05",
        "96.06",
        "96.07",
        "96.08",
        "96.09",
    ],
    "производство": [
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "20",
        "21",
        "22",
        "23",
        "24",
        "25",
        "26",
        "27",
        "28",
        "29",
        "30",
        "31",
        "32",
        "33",
        # Пищевые продукты
        "10.1",
        "10.2",
        "10.3",
        "10.4",
        "10.5",
        "10.6",
        "10.7",
        "10.8",
        "10.9",
        # Напитки
        "11.0",
        "11.01",
        "11.02",
        "11.03",
        "11.04",
        "11.05",
        "11.06",
        "11.07",
        # Табачные изделия
        "12.0",
        # Текстильные изделия
        "13.1",
        "13.2",
        "13.3",
        "13.4",
        "13.5",
        "13.6",
        "13.7",
        "13.8",
        "13.9",
        # Одежда
        "14.1",
        "14.2",
        "14.3",
        "14.4",
        "14.5",
        "14.6",
        "14.7",
        "14.8",
        "14.9",
        # Кожаные изделия
        "15.1",
        "15.2",
        "15.3",
        "15.4",
        "15.5",
        "15.6",
        "15.7",
        "15.8",
        "15.9",
        # Деревообработка
        "16.1",
        "16.2",
        "16.3",
        "16.4",
        "16.5",
        "16.6",
        "16.7",
        "16.8",
        "16.9",
        # Бумага
        "17.1",
        "17.2",
        "17.3",
        "17.4",
        "17.5",
        "17.6",
        "17.7",
        "17.8",
        "17.9",
        # Полиграфия
        "18.1",
        "18.2",
        "18.3",
        "18.4",
        "18.5",
        "18.6",
        "18.7",
        "18.8",
        "18.9",
        # Химия
        "20.1",
        "20.2",
        "20.3",
        "20.4",
        "20.5",
        "20.6",
        "20.7",
        "20.8",
        "20.9",
        # Лекарства
        "21.1",
        "21.2",
        "21.3",
        "21.4",
        "21.5",
        "21.6",
        "21.7",
        "21.8",
        "21.9",
        # Резина и пластмасса
        "22.1",
        "22.2",
        "22.3",
        "22.4",
        "22.5",
        "22.6",
        "22.7",
        "22.8",
        "22.9",
        # Неметаллическая минеральная продукция
        "23.1",
        "23.2",
        "23.3",
        "23.4",
        "23.5",
        "23.6",
        "23.7",
        "23.8",
        "23.9",
        # Металлургия
        "24.1",
        "24.2",
        "24.3",
        "24.4",
        "24.5",
        "24.6",
        "24.7",
        "24.8",
        "24.9",
        # Готовые металлические изделия
        "25.1",
        "25.2",
        "25.3",
        "25.4",
        "25.5",
        "25.6",
        "25.7",
        "25.8",
        "25.9",
        # Электроника и оптика
        "26.1",
        "26.2",
        "26.3",
        "26.4",
        "26.5",
        "26.6",
        "26.7",
        "26.8",
        "26.9",
        # Электрооборудование
        "27.1",
        "27.2",
        "27.3",
        "27.4",
        "27.5",
        "27.6",
        "27.7",
        "27.8",
        "27.9",
        # Машины и оборудование
        "28.1",
        "28.2",
        "28.3",
        "28.4",
        "28.5",
        "28.6",
        "28.7",
        "28.8",
        "28.9",
        # Автотранспорт
        "29.1",
        "29.2",
        "29.3",
        "29.4",
        "29.5",
        "29.6",
        "29.7",
        "29.8",
        "29.9",
        # Прочий транспорт
        "30.1",
        "30.2",
        "30.3",
        "30.4",
        "30.5",
        "30.6",
        "30.7",
        "30.8",
        "30.9",
        # Мебель
        "31.0",
        "31.01",
        "31.02",
        "31.03",
        "31.04",
        "31.05",
        "31.06",
        "31.07",
        "31.08",
        "31.09",
        # Прочие готовые изделия
        "32.1",
        "32.2",
        "32.3",
        "32.4",
        "32.5",
        "32.6",
        "32.7",
        "32.8",
        "32.9",
        # Ремонт и монтаж
        "33.1",
        "33.2",
        "33.3",
        "33.4",
        "33.5",
        "33.6",
        "33.7",
        "33.8",
        "33.9",
    ],
    "разведка и добыча": [
        "05",
        "06",
        "07",
        "08",
        "09",
        "05.1",
        "05.2",
        "05.3",
        "05.4",
        "05.5",
        "05.6",
        "05.7",
        "05.8",
        "05.9",
        "06.1",
        "06.2",
        "06.3",
        "06.4",
        "06.5",
        "06.6",
        "06.7",
        "06.8",
        "06.9",
        "07.1",
        "07.2",
        "07.3",
        "07.4",
        "07.5",
        "07.6",
        "07.7",
        "07.8",
        "07.9",
        "08.1",
        "08.2",
        "08.3",
        "08.4",
        "08.5",
        "08.6",
        "08.7",
        "08.8",
        "08.9",
        "09.1",
        "09.2",
        "09.3",
        "09.4",
        "09.5",
        "09.6",
        "09.7",
        "09.8",
        "09.9",
    ],
    "энергетика и водоснабжение": [
        "35",
        "36",
        "37",
        "38",
        "39",
        "35.1",
        "35.11",
        "35.12",
        "35.13",
        "35.14",
        "35.2",
        "35.21",
        "35.22",
        "35.23",
        "35.3",
        "35.30",
        "36.0",
        "36.00",
        "37.0",
        "38.1",
        "38.2",
        "38.3",
        "38.4",
        "38.5",
        "38.6",
        "38.7",
        "38.8",
        "38.9",
        "39.0",
    ],
    "металлургия": [
        "24.1",
        "24.10",  # Производство чугуна, стали и ферросплавов
        "24.2",
        "24.20",  # Производство стальных труб, полых профилей и фитингов
        "24.3",
        "24.30",  # Производство прочей продукции первого передела стали
        "24.4",
        "24.41",
        "24.42",
        "24.43",
        "24.44",
        "24.45",
        "24.46",
        "24.47",
        "24.48",
        "24.49",
        "24.5",
        "24.51",
        "24.52",
        "24.53",
        "24.54",  # Литье металлов
    ],
    "приборостроение": [
        "26.5",
        "26.51",
        "26.52",
        "26.6",
        "26.60",
        "26.7",
        "26.70",
        "26.8",
        "26.80",
        "27.1",
        "27.11",
        "27.12",
        "27.2",
        "27.20",
        "27.3",
        "27.31",
        "27.32",
        "27.33",
        "27.4",
        "27.40",
        "27.5",
        "27.51",
        "27.52",
    ],
    "легкая промышленность": [
        "13",
        "14",
        "15",
        "31",
        "13.1",
        "13.2",
        "13.3",
        "13.4",
        "13.5",
        "13.6",
        "13.7",
        "13.8",
        "13.9",
        "14.1",
        "14.2",
        "14.3",
        "14.4",
        "14.5",
        "14.6",
        "14.7",
        "14.8",
        "14.9",
        "15.1",
        "15.2",
        "15.3",
        "15.4",
        "15.5",
        "15.6",
        "15.7",
        "15.8",
        "15.9",
        "31.0",
        "31.01",
        "31.02",
        "31.03",
        "31.04",
        "31.05",
        "31.06",
        "31.07",
        "31.08",
        "31.09",
    ],
}


def extract_okved_codes(industry_string: str) -> list[str]:

    if not industry_string or pd.isna(industry_string):
        return []

    # Простой и эффективный способ извлечения кодов ОКВЭД
    codes = []

    # Разделяем строку по точкам с запятой
    parts = str(industry_string).split(";")

    for part in parts:
        part = part.strip()
        if not part:
            continue

        # Ищем код в начале части (формат: "XX.XX Описание")
        match = re.match(r"^(\d[\d\.]*)\s+", part)
        if match:
            code = match.group(1).rstrip(".")
            # Проверяем, что код валидный
            if any(char.isdigit() for char in code):
                codes.append(code)

    # Если не нашли через разделение, используем regex
    if not codes:
        codes = re.findall(r"\b(\d[\d\.]*)\b", str(industry_string))
        # Фильтруем только валидные коды
        codes = [
            code.rstrip(".") for code in codes if any(char.isdigit() for char in code)
        ]

    # Удаляем дубликаты
    unique_codes = []
    seen = set()
    for code in codes:
        if code not in seen:
            seen.add(code)
            unique_codes.append(code)

    return unique_codes


def get_industry_by_okved(okved_code: str) -> str | None:
    if not okved_code:
        return None

    clean_code = okved_code.strip()

    # 1. Пытаемся найти точное совпадение
    for industry, codes in OKVED_CATEGORIES.items():
        if clean_code in codes:
            return industry

    # 2. Если точного совпадения нет, ищем по основному коду
    # (например, для "24.10.11" сначала ищем "24.10", затем "24")
    parts = clean_code.split(".")

    # Пробуем все уровни кода от самого детального до общего
    for i in range(len(parts), 0, -1):
        partial_code = ".".join(parts[:i])

        # Ищем частичное совпадение
        for industry, codes in OKVED_CATEGORIES.items():
            if partial_code in codes:
                return industry

        # Также ищем по основному коду (без подпунктов)
        if i == 1:
            main_code = parts[0]
            for industry, codes in OKVED_CATEGORIES.items():
                for code in codes:
                    # Сравниваем основной код
                    if code.split(".")[0] == main_code:
                        # Но только если код в списке не слишком детальный
                        if len(code.split(".")) <= 2:  # Например, "24" или "24.1"
                            return industry

    return None


def get_industries_by_okved(industry_string: str) -> list[str]:
    if not industry_string or pd.isna(industry_string):
        return []

    # Извлекаем все коды ОКВЭД
    okved_codes = extract_okved_codes(industry_string)

    unique_categories = set()

    # Для каждого кода определяем категорию
    for code in okved_codes:
        category = get_industry_by_okved(code)
        if category:
            unique_categories.add(category)

    return list(unique_categories)


# Оставляем функцию filter_contracts_data без изменений (она уже использует эти функции)
