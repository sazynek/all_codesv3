import pandas as pd
import os
from typing import Optional


def add_year_column_to_excel(
    input_file: str, output_file: Optional[str] = None, year: str = "2025"
) -> bool:
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç–æ–ª–±–µ—Ü '–≥–æ–¥' —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º year –≤–æ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ Excel —Ñ–∞–π–ª–∞.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    ----------
    input_file : str
        –ü—É—Ç—å –∫ –≤—Ö–æ–¥–Ω–æ–º—É Excel —Ñ–∞–π–ª—É
    output_file : Optional[str]
        –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –ï—Å–ª–∏ None, –∑–∞–º–µ–Ω—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª
    year : str
        –ó–Ω–∞—á–µ–Ω–∏–µ –≥–æ–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "2025")

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    -----------
    bool
        True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, False –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
    """

    try:
        print(f"üìñ –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞: {input_file}")

        # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
        df = pd.read_excel(input_file)

        print(f"üìä –ù–∞–π–¥–µ–Ω–æ {len(df)} –∑–∞–ø–∏—Å–µ–π –≤ —Ñ–∞–π–ª–µ")
        print(f"üìã –°—Ç–æ–ª–±—Ü—ã –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {list(df.columns)}")

        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü '–≥–æ–¥' —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º year
        # –ï—Å–ª–∏ —Å—Ç–æ–ª–±–µ—Ü —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
        df["–≥–æ–¥"] = year

        # –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ–º —Å—Ç–æ–ª–±—Ü—ã: –≥–æ–¥ —Å—Ç–∞–≤–∏–º –ø–æ—Å–ª–µ '—Ä–µ–≥–∏–æ–Ω'
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤
        columns_order = list(df.columns)

        # –ï—Å–ª–∏ '—Ä–µ–≥–∏–æ–Ω' –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ, —Å—Ç–∞–≤–∏–º '–≥–æ–¥' –ø–æ—Å–ª–µ –Ω–µ–≥–æ
        if "—Ä–µ–≥–∏–æ–Ω" in columns_order:
            # –£–¥–∞–ª—è–µ–º '–≥–æ–¥' –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            columns_order.remove("–≥–æ–¥")
            # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å '—Ä–µ–≥–∏–æ–Ω'
            region_index = columns_order.index("—Ä–µ–≥–∏–æ–Ω")
            # –í—Å—Ç–∞–≤–ª—è–µ–º '–≥–æ–¥' –ø–æ—Å–ª–µ '—Ä–µ–≥–∏–æ–Ω'
            columns_order.insert(region_index + 1, "–≥–æ–¥")
        else:
            # –ï—Å–ª–∏ '—Ä–µ–≥–∏–æ–Ω' –Ω–µ—Ç, —Å—Ç–∞–≤–∏–º '–≥–æ–¥' –≤ –∫–æ–Ω–µ—Ü
            pass  # '–≥–æ–¥' —É–∂–µ –≤ –∫–æ–Ω—Ü–µ

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤
        df = df[columns_order]

        print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü '–≥–æ–¥' = {year}")
        print(f"üìã –°—Ç–æ–ª–±—Ü—ã –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {list(df.columns)}")

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
        if output_file is None:
            output_file = input_file
            print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª: {output_file}")
        else:
            print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª: {output_file}")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        df.to_excel(output_file, index=False)

        # –í—ã–≤–æ–¥–∏–º –ø—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        print(f"\nüìù –ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏):")
        print(f"{'='*80}")
        print(df[["—Å—Å—ã–ª–∫–∞", "–≥–æ–¥"]].head(3).to_string(index=False))
        print(f"{'='*80}")

        print(f"\n‚úÖ –£—Å–ø–µ—à–Ω–æ! –î–æ–±–∞–≤–ª–µ–Ω–æ {len(df)} –∑–∞–ø–∏—Å–µ–π —Å –≥–æ–¥–æ–º = {year}")
        print(f"üìÅ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_file}")

        return True

    except FileNotFoundError:
        print(f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {input_file}")
        return False
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
        import traceback

        traceback.print_exc()
        return False


def process_excel_with_year(
    file_path: str, year: str = "2025", backup: bool = True
) -> bool:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Excel —Ñ–∞–π–ª, –¥–æ–±–∞–≤–ª—è—è —Å—Ç–æ–ª–±–µ—Ü —Å –≥–æ–¥–æ–º —Å –æ–ø—Ü–∏–µ–π —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    ----------
    file_path : str
        –ü—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É
    year : str
        –ó–Ω–∞—á–µ–Ω–∏–µ –≥–æ–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    backup : bool
        –°–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    -----------
    bool
        True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, False –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
    """

    try:
        # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if backup and os.path.exists(file_path):
            import shutil
            import datetime

            # –°–æ–∑–¥–∞–µ–º –∏–º—è –¥–ª—è –±—ç–∫–∞–ø–∞
            timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            backup_dir = os.path.dirname(file_path)
            backup_file = os.path.join(
                backup_dir,
                f"{os.path.basename(file_path).replace('.xlsx', '')}_backup_{timestamp}.xlsx",
            )

            print(f"üìÇ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...")
            shutil.copy2(file_path, backup_file)
            print(f"‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: {backup_file}")

        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü —Å –≥–æ–¥–æ–º
        return add_year_column_to_excel(file_path, year=year)

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
        return False


# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    input_excel = "contracts_data.xlsx"  # –í–∞—à —Ñ–∞–π–ª
    process_excel_with_year(input_excel, "2025")
