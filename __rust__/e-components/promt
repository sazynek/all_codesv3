use animation::egui_integration::AnimationManager;
use animation::{Animation, SpringConfig};
use egui::{Color32, Id, Pos2, Rect, Stroke};
use std::time::Duration;

fn main() -> eframe::Result {
    let native_options = eframe::NativeOptions {
        viewport: egui::ViewportBuilder{
            max_inner_size:Some(egui::Vec2::new(800.0, 600.0)),
            ..Default::default()},
        ..Default::default()
    };
    
    eframe::run_native(
        "Global Ripple Effect Demo",
        native_options,
        Box::new(|_cc| Ok(Box::new(GlobalRippleApp::new()))),
    )
}

struct GlobalRippleApp {
    animation_manager: AnimationManager,
    background_color: Color32,
    ripple_intensity: f32,
    show_debug_info: bool,
}

impl GlobalRippleApp {
    fn new() -> Self {
        Self {
            animation_manager: AnimationManager::new(),
            background_color: Color32::from_rgb(25, 25, 35),
            ripple_intensity: 1.0,
            show_debug_info: false,
        }
    }
}

impl eframe::App for GlobalRippleApp {
    fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏
        self.animation_manager.update(ctx);

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ –≤—Å–µ–º—É —ç–∫—Ä–∞–Ω—É
        let screen_rect = ctx.screen_rect();
        let response = ctx.input(|i| {
            if i.pointer.primary_clicked() {
                i.pointer.interact_pos()
            } else {
                None
            }
        });

        if let Some(click_pos) = response {
            // –°–æ–∑–¥–∞–µ–º ripple —ç—Ñ—Ñ–µ–∫—Ç –≤ –ø–æ–∑–∏—Ü–∏–∏ –∫–ª–∏–∫–∞
            self.animation_manager.create_global_ripple(click_pos, ctx);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —Ñ–æ–Ω–∞
            self.animation_manager.add_animation(Animation::new_tween(
                "background_pulse",
                0.0,
                1.0,
                Duration::from_millis(300),
            ).with_on_complete({
                let manager = self.animation_manager.clone();
                move || {
                    manager.add_animation(Animation::new_tween(
                        "background_pulse",
                        1.0,
                        0.0,
                        Duration::from_millis(300),
                    ));
                }
            }));
        }

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É–ª—å—Å–∞—Ü–∏–∏ —Ñ–æ–Ω–∞
        let bg_pulse = self.animation_manager.get_value("background_pulse").unwrap_or(0.0) as f32;

        // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        egui::CentralPanel::default()
            .frame(egui::Frame {
                fill: self.background_color.gamma_multiply(1.0 + bg_pulse * 0.1),
                stroke: Stroke::NONE,
                ..Default::default()
            })
            .show(ctx, |ui| {
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                ui.vertical_centered(|ui| {
                    ui.heading("üåä Global Ripple Effect Demo");
                    ui.label("Click anywhere on the screen to create beautiful ripple effects!");
                    ui.add_space(20.0);
                });

                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å
                ui.horizontal(|ui| {
                    ui.label("üí° Tips:");
                    ui.label("‚Ä¢ Click anywhere to create ripples");
                    ui.label("‚Ä¢ Try different areas for different colors");
                });

                ui.add_space(30.0);

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                ui.collapsing("Settings", |ui| {
                    ui.horizontal(|ui| {
                        ui.label("Background:");
                        if ui.button("Dark").clicked() {
                            self.background_color = Color32::from_rgb(25, 25, 35);
                        }
                        if ui.button("Light").clicked() {
                            self.background_color = Color32::from_rgb(240, 240, 245);
                        }
                        if ui.button("Blue").clicked() {
                            self.background_color = Color32::from_rgb(30, 35, 60);
                        }
                    });

                    ui.add(egui::Slider::new(&mut self.ripple_intensity, 0.5..=2.0).text("Ripple Intensity"));

                    ui.checkbox(&mut self.show_debug_info, "Show debug info");
                });

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                if self.show_debug_info {
                    ui.add_space(20.0);
                    ui.collapsing("Debug Info", |ui| {
                        ui.label(format!("Active animations: {}", {
                            let timeline = self.animation_manager.timeline.lock().unwrap();
                            timeline.animation_count()
                        }));
                        ui.label(format!("Active ripples: {}", {
                            let ripples = self.animation_manager.ripples.lock().unwrap();
                            ripples.len()
                        }));
                        ui.label(format!("Background pulse: {:.3}", bg_pulse));
                    });
                }

                // –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∑–æ–Ω–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
                ui.add_space(50.0);
                ui.vertical_centered(|ui| {
                    let response = ui.add(
                        egui::Button::new("üéØ Click This Area Too!")
                            .min_size(egui::Vec2::new(200.0, 60.0))
                    );
                    
                    if response.clicked() {
                        // –°–æ–∑–¥–∞–µ–º ripple –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–Ω–æ–ø–∫–∏
                        let button_center = response.rect.center();
                        self.animation_manager.create_global_ripple(button_center, ctx);
                    }
                    
                    ui.add_space(20.0);
                    ui.label("The ripple colors change based on where you click!");
                });

                // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞
                ui.add_space(40.0);
                ui.horizontal(|ui| {
                    ui.label("Color gradient:");
                    let width = ui.available_width();
                    let height = 20.0;
                    let rect = ui.allocate_space(egui::Vec2::new(width, height)).0;
                    
                    for i in 0..width as usize {
                        let x = i as f32;
                        let normalized_x = x / width;
                        let hue = normalized_x * 360.0;
                        let color = self.animation_manager.hsv_to_rgb(hue, 0.8, 0.9);
                        
                        ui.painter().rect_filled(
                            Rect::from_min_size(
                                Pos2::new(rect.value() as f32 + x, rect.value() as f32),
                                egui::Vec2::new(1.0, height),
                            ),
                            egui::Rounding::ZERO,
                            color,
                        );
                    }
                });

                ui.add_space(10.0);
                ui.label("‚Üê Colors change based on horizontal position ‚Üí");
            });

        // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º ripple —ç—Ñ—Ñ–µ–∫—Ç—ã –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ UI
        egui::Area::new(Id::from("ripples_layer"))
            .order(egui::Order::Foreground)
            .interactable(false) // —á—Ç–æ–±—ã –∫–ª–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Å–∫–≤–æ–∑—å
            .show(ctx, |ui| {
                self.animation_manager.paint_global_ripples(ui);
            });
    }
}